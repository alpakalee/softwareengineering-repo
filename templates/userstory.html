<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Story</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='topbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='userstory.css') }}">

    <script>
        function enableEdit(storyId) {
            var storyContent = document.getElementById('story-content-' + storyId);
            var editForm = document.getElementById('edit-form-' + storyId);
            storyContent.style.display = 'none';
            editForm.style.display = 'inline';
            var inputField = editForm.querySelector('input[name="content"]');
            inputField.focus();
            inputField.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    editForm.submit();
                }
            });
        }

        
    </script>

</head>
<body>
    {% include 'topbar.html' %}
    <div class="main-container">
        {% include 'sidebar.html' %}
        <div class="content">
            <!-- Not List -->
            <div class="not-list-box">
                <div class="not-list-header">
                    <h2>Not List</h2>
                    <img src="{{ url_for('static', filename='icons/setting.svg') }}" alt="설정 아이콘" class="settings-icon"  onclick="openModal();">
                </div>
                <div class="not-list-keywords" id="notListKeywordsDisplay">
                    {% for item in not_list %}
                    <li class="notlist-item">
                        {{ item.keyword }}
                    </li>
                {% else %}
                    <li class="notlist-item">No keywords found.</li>
                {% endfor %}
                </div>
            </div>
            
            <!-- 유저스토리 -->
            <div class="userstory-container">
                <h2>유저스토리</h2>
                <div class="userstory-list" id="userStoryList">
                    <!-- JavaScript로 유저 스토리가 추가될 영역 -->
                    {% for story in stories %}
                    <li class="userstory-item">
                        <span id="story-content-{{ story.story_id }}">{{ story.user_story_content }}</span>
                        <form id="edit-form-{{ story.story_id }}" action="{{ url_for('userstory.update_story_route', project_id=project_id, story_id=story.story_id) }}" method="POST" style="display:none;" class="edit-input">
                            <input type="hidden" name="_method" value="PUT">
                            <input type="hidden" name="story_id" value="{{ story.story_id }}">
                            <input type="text" name="content" value="{{ story.user_story_content }}">
                            
                        </form>
                        
                        <button class="edit-story" type="button" onclick="enableEdit('{{ story.story_id }}')">수정</button>
                        <form action="{{ url_for('userstory.delete_story_route', project_id=project_id, story_id=story.story_id) }}" method="POST" style="display:inline;">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit"  class="delete-story">삭제</button>
                        </form>
                        
                    </li>
                {% else %}
                    <li class="userstory-item">유저스토리가 없습니다.</li>
                {% endfor %}
                </div>
            </div>
            
            <!-- 유저 스토리 입력 섹션 -->
            <div class="userstory-input-container">
                <form action="{{ url_for('userstory.create_story_route', project_id=project_id) }}" method="POST">
                    <input type="text" name="content" placeholder="유저스토리를 작성해주세요. 엔터를 누를 시 자동으로 유저스토리에 등록됩니다.">
            </div>
            
            <!-- 모달창 -->
            <div class="modal-background" id="modalBackground" onclick="closeModal();"></div>
            <div class="not-list-modal" id="notListModal">
                <div class="modal-header">
                    <h1>NOT LIST 키워드 관리</h1>
                    <img src="{{ url_for('static', filename='icons/xbutton.svg') }}" alt="Close" class="close-icon" onclick="closeModal();">
                </div>
                <div  class="modal-keyword-list">
                    <ul>
                        {% for item in not_list %}
                            <li class="notlist-item">
                                {{ item.keyword }}
                                
                                <form action="{{ url_for('notlist.delete_keyword_route', project_id=project_id, not_list_id=item.not_list_id) }}" method="POST" style="display:inline;" >   
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" class="delete-story">삭제</button>
                                </form>
                                
                            </li>
                        {% else %}
                            <li class="notlist-item">No keywords found.</li>
                        {% endfor %}
                    </ul>
                </div>
                <form id="keywordForm">
                    <input type="text" id="newKeywordInput" placeholder="추가할 키워드를 입력하세요. 엔터로 등록합니다." class="add-keyword-input">
                </form>
            </div>
            
            
            <div class="modal-background" id="keywordWarningBackground"></div>
            <div class="keyword-warning-modal" id="keywordWarningModal">
                <h2>Not List 키워드 발견</h2>
                <p>해당 유저스토리에 <span class="highlight">Not List 키워드</span>가 포함되어 있습니다.<br>확인을 누를 시 PM에게 알림이 갑니다.</p>
                <button class="confirm-button" onclick="confirmKeywordWarning()">확인</button>
                <button class="cancel-button" onclick="cancelKeywordWarning()">취소</button>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/userstory.js') }}"></script>
</body>

<script>
document.querySelector('.add-keyword-input').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();

        // 키워드 입력값 가져오기
        const keyword = event.target.value.trim();
        if (!keyword) return;  // 빈 값은 처리하지 않음

        // AJAX 요청 보내기 (폼 데이터를 서버로 전달)
        fetch(`/notlist/{{ project_id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'  // 폼 형식으로 데이터 전송
            },
            body: new URLSearchParams({
                'keyword': keyword  // 폼 데이터 형식으로 키워드 전송
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);  // 서버 에러 처리
            } else {
                // 새로 추가된 키워드를 모달 내 목록에 즉시 추가
                const keywordList = document.querySelector('.modal-keyword-list ul');
                const newKeywordItem = document.createElement('li');
                newKeywordItem.classList.add('notlist-item');
                newKeywordItem.innerHTML = `
                    ${data.keyword}
                    <button class="delete-keyword">삭제</button>
                `;
                keywordList.appendChild(newKeywordItem);

                // 삭제 버튼 이벤트 추가
                newKeywordItem.querySelector('.delete-keyword').addEventListener('click', function() {
                    // 삭제 요청
                    fetch(`/notlist/{{ project_id }}/${data.id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            '_method': 'DELETE'  // HTTP DELETE 요청 방식
                        })
                    })
                    .then(response => response.json())
                    .then(deleteData => {
                        if (deleteData.success) {
                            // 삭제된 키워드 항목 UI에서 제거
                            newKeywordItem.remove();
                        } else {
                            alert('삭제 실패');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });

                // 입력 필드 초기화
                event.target.value = '';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});


</script>
</html>